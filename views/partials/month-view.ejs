<div class="month-calendar">
    <div class="weekdays">
        <div>å‘¨æ—¥</div>
        <div>å‘¨ä¸€</div>
        <div>å‘¨äºŒ</div>
        <div>å‘¨ä¸‰</div>
        <div>å‘¨å››</div>
        <div>å‘¨äº”</div>
        <div>å‘¨å…­</div>
    </div>
    <div class="days">
        <%
            const firstDay = moment(`${year}-${month.toString().padStart(2, '0')}-01`);
            const startOfWeek = firstDay.clone().startOf('week');
            const endOfMonth = firstDay.clone().endOf('month');
            const endOfWeek = endOfMonth.clone().endOf('week');
            
            for (let day = startOfWeek.clone(); day.isSameOrBefore(endOfWeek); day.add(1, 'day')) {
                const isCurrentMonth = day.month() + 1 === month;
                const isToday = day.format('YYYY-MM-DD') === today;
                const dateKey = day.format('YYYY-MM-DD');
                const dayEvents = events[dateKey] || [];
                const eventCount = dayEvents.length;
        %>
            <div class="day <%= isCurrentMonth ? 'current-month' : 'other-month' %> <%= isToday ? 'today' : '' %>"
                 data-bg-color="<%= isCurrentMonth ? getDateColor(day.toDate()) : '#f5f5f5' %>"
                 onclick="openEventModal('<%= dateKey %>')">
                <div class="day-header">
                    <span class="day-number"><%= day.date() %></span>
                    <% if (isCurrentMonth && isWorkday(day.toDate())) { %>
                        <span class="avatar work">ðŸ’ª</span>
                    <% } else if (isCurrentMonth && !isWorkday(day.toDate())) { %>
                        <span class="avatar rest">ðŸ˜Ž</span>
                    <% } %>
                </div>
                <% 
                    // èŽ·å–æ—¥æœŸè¡¨æƒ…
                    const dateEmoji = dayEvents.find(event => event.type === 'date-emoji');
                    const regularEvents = dayEvents.filter(event => event.type !== 'date-emoji');
                %>
                
                <% if (dateEmoji) { %>
                    <div class="date-emoji-display">
                        <%= dateEmoji.emoji %>
                    </div>
                <% } %>
                
                <% if (regularEvents.length > 0) { %>
                    <div class="event-preview">
                        <% regularEvents.slice(0, 2).forEach(event => { %>
                            <div class="event-item" data-border-color="<%= eventCategories[event.category]?.color || '#ccc' %>">
                                <% if (event.emoji) { %>
                                    <span class="event-emoji"><%= event.emoji %></span>
                                <% } %>
                                <span class="event-category-icon"><%= eventCategories[event.category]?.icon || 'ðŸ“' %></span>
                                <%= event.text.length > 10 ? event.text.substring(0, 10) + '...' : event.text %>
                            </div>
                        <% }); %>
                        <% if (regularEvents.length > 2) { %>
                            <div class="more-events">+<%= regularEvents.length - 2 %> æ›´å¤š</div>
                        <% } %>
                    </div>
                <% } %>
                
                <div class="day-actions">
                    <button class="mini-btn" onclick="setDateEmoji('<%= dateKey %>')" title="è®¾ç½®æ—¥æœŸè¡¨æƒ…">ðŸ˜Š</button>
                </div>
            </div>
        <% } %>
    </div>
</div>