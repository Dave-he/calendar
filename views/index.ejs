<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多巴胺日历</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🌈 多巴胺日历 🌈</h1>
            <div class="controls">
                <div class="view-controls">
                    <button class="btn <%= view === 'year' ? 'active' : '' %>" onclick="changeView('year')">年视图</button>
                    <button class="btn <%= view === 'month' ? 'active' : '' %>" onclick="changeView('month')">月视图</button>
                    <button class="btn <%= view === 'day' ? 'active' : '' %>" onclick="changeView('day')">日视图</button>
                </div>
                <div class="navigation">
                    <button class="btn" onclick="navigate(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="current-date">
                        <% if (view === 'year') { %>
                            <%= year %>年
                        <% } else if (view === 'month') { %>
                            <%= year %>年 <%= month %>月
                        <% } else { %>
                            <%= moment().format('YYYY年MM月DD日') %>
                        <% } %>
                    </span>
                    <button class="btn" onclick="navigate(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="quick-actions">
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="🔍 搜索事件..." onkeyup="handleSearch(event)">
                        <button class="btn search-btn" onclick="performSearch()">搜索</button>
                    </div>
                    <button class="btn today-btn" onclick="goToToday()">今天</button>
                    <input type="date" id="dateJump" onchange="jumpToDate(this.value)">
                    <div class="category-filter">
                        <select id="categoryFilter" onchange="filterByCategory(this.value)">
                            <option value="">所有分类</option>
                            <option value="work">💼 工作</option>
                            <option value="life">🏠 生活</option>
                            <option value="study">📚 学习</option>
                            <option value="entertainment">🎮 娱乐</option>
                            <option value="health">💪 健康</option>
                            <option value="social">👥 社交</option>
                            <option value="travel">✈️ 旅行</option>
                            <option value="other">📝 其他</option>
                        </select>
                    </div>
                    <div class="data-actions">
                        <button class="btn" onclick="showEmojiManager()">😊 表情</button>
                        <button class="btn" onclick="exportData()">📤 导出</button>
                        <button class="btn" onclick="showImportModal()">📥 导入</button>
                        <button class="btn" onclick="createBackup()">💾 备份</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="calendar-container">
            <% if (view === 'year') { %>
                <%- include('partials/year-view') %>
            <% } else if (view === 'month') { %>
                <%- include('partials/month-view') %>
            <% } else { %>
                <%- include('partials/day-view') %>
            <% } %>
        </main>
    </div>

    <!-- 事件模态框 -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>📅 <span id="modalDate"></span></h2>
            <div class="event-form">
                <div class="category-selector">
                    <label for="eventCategory">选择分类：</label>
                    <select id="eventCategory">
                        <option value="work">💼 工作</option>
                        <option value="life">🏠 生活</option>
                        <option value="study">📚 学习</option>
                        <option value="entertainment">🎮 娱乐</option>
                        <option value="health">💪 健康</option>
                        <option value="social">👥 社交</option>
                        <option value="travel">✈️ 旅行</option>
                        <option value="other" selected>📝 其他</option>
                    </select>
                </div>
                <div class="emoji-selector">
                    <label for="eventEmoji">选择表情：</label>
                    <div class="emoji-picker">
                        <input type="text" id="eventEmoji" placeholder="点击选择表情" readonly onclick="showEmojiPicker('eventEmoji')">
                        <button type="button" onclick="clearEmoji('eventEmoji')">清除</button>
                    </div>
                </div>
                <textarea id="eventText" placeholder="记录今天的美好时光..."></textarea>
                <button onclick="addEvent()">添加事件</button>
            </div>
            <div id="eventList"></div>
        </div>
    </div>

    <!-- 搜索结果模态框 -->
    <div id="searchModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSearchModal()">&times;</span>
            <h2>🔍 搜索结果</h2>
            <div id="searchResults"></div>
        </div>
    </div>

    <!-- 导入数据模态框 -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeImportModal()">&times;</span>
            <h2>📥 导入数据</h2>
            <div class="import-form">
                <div class="import-options">
                    <label>
                        <input type="radio" name="importMode" value="replace" checked>
                        替换现有数据
                    </label>
                    <label>
                        <input type="radio" name="importMode" value="merge">
                        合并到现有数据
                    </label>
                </div>
                <div class="file-input-area">
                    <input type="file" id="importFile" accept=".json" onchange="handleFileSelect(event)">
                    <div class="file-drop-area" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)">
                        <p>拖拽JSON文件到这里，或点击选择文件</p>
                    </div>
                </div>
                <button onclick="importData()" disabled id="importBtn">导入数据</button>
            </div>
        </div>
    </div>

    <!-- 表情管理器模态框 -->
    <div id="emojiManagerModal" class="modal">
        <div class="modal-content emoji-manager">
            <span class="close" onclick="closeEmojiManager()">&times;</span>
            <h2>😊 表情管理器</h2>
            
            <div class="emoji-tabs">
                <button class="tab-btn active" onclick="switchEmojiTab('built-in')">内置表情</button>
                <button class="tab-btn" onclick="switchEmojiTab('custom')">自定义表情</button>
                <button class="tab-btn" onclick="switchEmojiTab('upload')">上传表情</button>
            </div>
            
            <div id="builtInEmojis" class="emoji-tab-content active">
                <div class="emoji-categories"></div>
            </div>
            
            <div id="customEmojis" class="emoji-tab-content">
                <div class="custom-emoji-list"></div>
            </div>
            
            <div id="uploadEmojis" class="emoji-tab-content">
                <div class="upload-form">
                    <h3>上传自定义表情</h3>
                    <div class="form-group">
                        <label for="emojiName">表情名称：</label>
                        <input type="text" id="emojiName" placeholder="给你的表情起个名字">
                    </div>
                    <div class="form-group">
                        <label for="emojiCategory">分类：</label>
                        <select id="emojiCategory">
                            <option value="custom">自定义</option>
                            <option value="mood">心情</option>
                            <option value="activities">活动</option>
                            <option value="food">美食</option>
                            <option value="nature">自然</option>
                            <option value="animals">动物</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="emojiFile">选择图片：</label>
                        <input type="file" id="emojiFile" accept="image/*" onchange="previewEmoji(event)">
                        <div class="emoji-preview" id="emojiPreview"></div>
                    </div>
                    <button onclick="uploadCustomEmoji()">上传表情</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 表情选择器模态框 -->
    <div id="emojiPickerModal" class="modal">
        <div class="modal-content emoji-picker-modal">
            <span class="close" onclick="closeEmojiPicker()">&times;</span>
            <h3>选择表情</h3>
            <div class="emoji-picker-tabs">
                <button class="picker-tab-btn active" onclick="switchPickerTab('built-in')">内置</button>
                <button class="picker-tab-btn" onclick="switchPickerTab('custom')">自定义</button>
            </div>
            <div id="emojiPickerContent" class="emoji-picker-content"></div>
        </div>
    </div>

    <!-- 日期表情设置模态框 -->
    <div id="dateEmojiModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDateEmojiModal()">&times;</span>
            <h2>🗓️ 设置日期表情</h2>
            <p>为 <span id="dateEmojiDate"></span> 选择一个表情</p>
            <div class="date-emoji-picker">
                <input type="text" id="dateEmojiInput" placeholder="点击选择表情" readonly onclick="showEmojiPicker('dateEmojiInput')">
                <button onclick="saveDateEmoji()">保存</button>
                <button onclick="clearDateEmoji()">清除</button>
            </div>
        </div>
    </div>

    <script>
        // 将服务器数据传递给客户端
        window.supportedCountries =  JSON.stringify(supportedCountries);
        window.holidays = JSON.stringify(holidays);
        window.userCountry = '<%= userCountry %>';
        window.userLanguage = '<%= userLanguage %>';
    </script>
    <script src="/js/script.js"></script>
</body>
</html>